# run a container from the images, with mounted external storage and specified cpu and mem

# docker buildx build -t sfdc:1.4.9 -f ./docker/sfdc/sfdc_dockerfile .

# docker run \
#  --mount type=bind,src=/data-storage/logs,dst=/logs \
#  --mount type=bind,src=/data-storage/sfdc_apps,dst=/sfdc_apps \
#   -m 2048m --cpus="2" --detach \
#  -p 3000:3000  -p 4000:4000 -p 9001:9001 \
# sfdc:1.4.9




FROM ubuntu:22.04 AS base

EXPOSE 3000 4000
RUN apt update && apt install \
    iproute2 \
    supervisor \
    python3-pip \
    python3-venv \
    nginx \
    nano \
    unixodbc \
    curl \
    iputils-ping \
    -y 

#Download and install the Microsoft ODBC driver for SQL Server on Ubuntu
#https://learn.microsoft.com/en-us/sql/connect/odbc/

RUN curl -sSL -O https://packages.microsoft.com/config/ubuntu/$(grep VERSION_ID /etc/os-release | cut -d '"' -f 2)/packages-microsoft-prod.deb
RUN dpkg -i packages-microsoft-prod.deb
RUN rm packages-microsoft-prod.deb
RUN apt update
RUN ACCEPT_EULA=Y apt install -y msodbcsql18
# optional: for bcp and sqlcmd
RUN ACCEPT_EULA=Y apt install -y mssql-tools18
RUN echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc
RUN bash -c "source ~/.bashrc" 

ADD  . /data-storage/sfdc_apps
COPY ./configs/nginx/sfdc /etc/nginx/sites-enabled
COPY ./configs/odbc.ini /etc/
COPY ./docker/sfdc/supervisord_backend_container.conf /etc/supervisor/conf.d
RUN rm /etc/init.d/nginx

RUN python3 -m venv env0
# same as running source /env0/bin/activate
RUN bash -c "source /env0/bin/activate" 
RUN bash -c "/env0/bin/pip install --upgrade pip"
RUN bash -c "/env0/bin/pip install -r /data-storage/sfdc_apps/requirements.txt"
CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
# ENTRYPOINT ["tail", "-f", "/dev/null"]